0 origin
defer, bootstrap

( Top-Level Variables and Constants )

$1000 const, TBlink

$B000 const, kqstat
$B002 const, kqdata

$C000 const, Base
-16000 $C000 - const, -eovm

79 const, W-1
24 const, H-1
-80 const, -W
 80 const, W
-25 const, -H

int, counter	( cursor count-down timer )
char, g		( character to output to the screen )
char, k		( PS/2 keycode to print to the screen )
int, p		( current video memory pointer )
int, q		( current font memory pointer )
int, vis	( Is cursor presently visible to the user? )
int, x		( glyph column number )
int, y		( glyph row number )

( Lookup Tables )

create, fontBase \ ============================================
: m,	dup 8 rshift c,, c,, ;
hex
00f0 m, 0f00 m, 000f m, 0000 m, 0000 m, 0000 m, 0000 m, 0000 m, 
0000 m, 0000 m, 0000 m, 0000 m, 0000 m, 0000 m, 0000 m, 0000 m, 
0018 m, 666c m, 1870 m, 3818 m, 0c30 m, 0000 m, 0000 m, 0000 m, 
1808 m, 3c3c m, 0c7e m, 1c7e m, 3c3c m, 0000 m, 0400 m, 203c m, 
3c10 m, 7c1e m, 787e m, 7e3c m, 663c m, 0666 m, 6042 m, 663c m, 
7c3c m, 7c3c m, 7e66 m, c666 m, 6666 m, 7e3c m, 003c m, 1800 m, 
3000 m, 6000 m, 0600 m, 1c00 m, 6000 m, 0060 m, 1800 m, 0000 m, 
0000 m, 0000 m, 0800 m, 0000 m, 0000 m, 000c m, 1830 m, 36aa m, 
8040 m, 2010 m, 0804 m, 0201 m, ff00 m, 0000 m, 0000 m, 0000 m, 
ffff m, ffc0 m, e0f0 m, 8001 m, 8001 m, ffff m, 0004 m, 0020 m, 
0010 m, 1018 m, 0044 m, 1038 m, 2838 m, 3800 m, 0000 m, 387c m, 
1010 m, 3838 m, 0800 m, 7c00 m, 0010 m, 3800 m, 3030 m, c010 m, 
2008 m, 1034 m, 2810 m, 2e38 m, 2008 m, 1028 m, 2008 m, 1028 m, 
7034 m, 2008 m, 1034 m, 2800 m, 3c20 m, 0810 m, 2808 m, 2030 m, 
1008 m, 1034 m, 2810 m, 0000 m, 2008 m, 1028 m, 2008 m, 1028 m, 
4834 m, 2008 m, 1034 m, 2800 m, 0220 m, 0810 m, 2808 m, 4028 m, 
00f0 m, 0f00 m, 000f m, 0000 m, 0000 m, 0000 m, 0000 m, 0000 m, 
0000 m, 0000 m, 0000 m, 0000 m, 0000 m, 0000 m, 0000 m, 0000 m, 
0018 m, 666c m, 3e54 m, 6c18 m, 1818 m, 2418 m, 0000 m, 0006 m, 
2418 m, 6666 m, 1c40 m, 3006 m, 6666 m, 1818 m, 0c00 m, 3066 m, 
6638 m, 6630 m, 6c60 m, 6060 m, 6618 m, 066c m, 6066 m, 7666 m, 
6666 m, 6666 m, 1866 m, c666 m, 6666 m, 0630 m, 600c m, 1800 m, 
1800 m, 6000 m, 0600 m, 3000 m, 6018 m, 1860 m, 1800 m, 0000 m, 
0000 m, 0000 m, 1800 m, 0000 m, 0000 m, 0018 m, 1818 m, 6c55 m, 
8040 m, 2010 m, 0804 m, 0201 m, 00ff m, 0000 m, 0000 m, 0000 m, 
ffff m, ffc0 m, e0f0 m, 4002 m, c003 m, 7ffe m, 0004 m, 0020 m, 
0000 m, 3820 m, 4444 m, 1040 m, 0054 m, 1c14 m, 0000 m, 7400 m, 
2810 m, 0404 m, 1000 m, f400 m, 0030 m, 4450 m, 1010 m, 2000 m, 
1010 m, 2858 m, 0028 m, 5844 m, 1010 m, 2800 m, 1010 m, 2800 m, 
4858 m, 1010 m, 2858 m, 0044 m, 4c10 m, 1028 m, 0010 m, 2048 m, 
0810 m, 2858 m, 0028 m, 0000 m, 1010 m, 2800 m, 1010 m, 2800 m, 
3058 m, 1010 m, 2858 m, 0010 m, 3c10 m, 1028 m, 0010 m, 4000 m, 
00f0 m, 0f00 m, 000f m, 0000 m, 0000 m, 0000 m, 0000 m, 0000 m, 
0000 m, 0000 m, 0000 m, 0000 m, 0000 m, 0000 m, 0000 m, 0000 m, 
0018 m, 24fe m, 5868 m, 6818 m, 300c m, 1818 m, 0000 m, 000c m, 
6638 m, 0606 m, 3c7c m, 600c m, 6666 m, 1818 m, 187e m, 1806 m, 
6e38 m, 6660 m, 6660 m, 6060 m, 6618 m, 0678 m, 607e m, 7666 m, 
6666 m, 6660 m, 1866 m, 6c66 m, 3c3c m, 0c30 m, 300c m, 3c00 m, 
0c3c m, 7c3e m, 3e3c m, 303e m, 7c00 m, 0066 m, 18fc m, 5c3c m, 
7c3e m, 5e3e m, 3c66 m, 66c6 m, 6666 m, 7e18 m, 1818 m, 00aa m, 
8040 m, 2010 m, 0804 m, 0201 m, 0000 m, ff00 m, 0000 m, 0000 m, 
00ff m, ffc0 m, e0f0 m, 2004 m, e007 m, 3ffc m, e004 m, 0720 m, 
0010 m, 5420 m, 3828 m, 1038 m, 006c m, 6428 m, 7c00 m, 6c00 m, 
107c m, 181c m, 0044 m, f400 m, 0010 m, 4428 m, 1010 m, c410 m, 
0000 m, 0000 m, 0010 m, 5840 m, 7c7c m, 7c7c m, 3838 m, 3838 m, 
4444 m, 3838 m, 3838 m, 3828 m, 5400 m, 0000 m, 0044 m, 3850 m, 
3838 m, 3838 m, 3810 m, 6c38 m, 3838 m, 3838 m, 0000 m, 0000 m, 
0858 m, 3838 m, 3838 m, 3800 m, 4c44 m, 4400 m, 4444 m, 5844 m, 
00f0 m, 0f00 m, 000f m, 0000 m, 0000 m, 0000 m, 0000 m, 0000 m, 
0000 m, 0000 m, 0000 m, 0000 m, 0000 m, 0000 m, 0000 m, 0000 m, 
0018 m, 006c m, 3c10 m, 3200 m, 300c m, 7e7e m, 007e m, 0018 m, 
6618 m, 0c1c m, 6c06 m, 7c0c m, 3c3e m, 0000 m, 3000 m, 0c0c m, 
6a6c m, 7c60 m, 6678 m, 786e m, 7e18 m, 0670 m, 607e m, 7e66 m, 
7c66 m, 7c3c m, 1866 m, 6c7e m, 183c m, 1830 m, 180c m, 3c00 m, 
0006 m, 6660 m, 6666 m, 7c66 m, 6638 m, 186c m, 18d6 m, 6666 m, 
6666 m, 6060 m, 1866 m, 66c6 m, 3c66 m, 0c60 m, 1806 m, 0055 m, 
8040 m, 2010 m, 0804 m, 0201 m, 0000 m, 00ff m, 0000 m, 0000 m, 
0000 m, ffc0 m, e0f0 m, 1008 m, f00f m, 1ff8 m, 1808 m, 1810 m, 
0010 m, 5070 m, 287c m, 0044 m, 0064 m, 3c50 m, 0438 m, 7400 m, 
0010 m, 2004 m, 0044 m, 7410 m, 0010 m, 3814 m, 7c7c m, 2820 m, 
1010 m, 1010 m, 1010 m, 8c40 m, 4040 m, 4040 m, 1010 m, 1010 m, 
e464 m, 4444 m, 4444 m, 4410 m, 5444 m, 4444 m, 4428 m, 2478 m, 
0404 m, 0404 m, 0438 m, 1244 m, 4444 m, 4444 m, 3030 m, 3030 m, 
3864 m, 4444 m, 4444 m, 447c m, 5444 m, 4444 m, 4444 m, 6444 m, 
0000 m, 00f0 m, 0ff0 m, 0000 m, 0000 m, 0000 m, 0000 m, 0000 m, 
0000 m, 0000 m, 0000 m, 0000 m, 0000 m, 0000 m, 0000 m, 0000 m, 
0018 m, 00fe m, 1a2c m, 6c00 m, 300c m, 1818 m, 1000 m, 0030 m, 
6618 m, 3006 m, 7e06 m, 6618 m, 6606 m, 0018 m, 187e m, 1818 m, 
667c m, 6660 m, 6660 m, 6066 m, 6618 m, 6678 m, 6066 m, 6e66 m, 
6066 m, 7806 m, 1866 m, 387e m, 3c18 m, 3030 m, 0c0c m, 6600 m, 
003e m, 6660 m, 667e m, 3066 m, 6618 m, 1878 m, 18d6 m, 6666 m, 
6666 m, 603c m, 1866 m, 3cd6 m, 1866 m, 1818 m, 1818 m, 00aa m, 
8040 m, 2010 m, 0804 m, 0201 m, 0000 m, 0000 m, ff00 m, 0000 m, 
0000 m, 00c0 m, e0f0 m, 0810 m, f81f m, 0ff0 m, 0818 m, 1018 m, 
0010 m, 5420 m, 3810 m, 1038 m, 006c m, 7c28 m, 0000 m, 6c00 m, 
0010 m, 3c38 m, 0044 m, 1400 m, 0010 m, 0028 m, 0830 m, d440 m, 
2828 m, 2828 m, 2828 m, f840 m, 7070 m, 6070 m, 1010 m, 1010 m, 
4454 m, 4444 m, 4444 m, 4428 m, 5444 m, 4444 m, 4410 m, 3844 m, 
3c3c m, 3c3c m, 3c1c m, 7e40 m, 7c7c m, 7c7c m, 1010 m, 1010 m, 
4444 m, 4444 m, 4444 m, 4400 m, 6444 m, 4444 m, 4444 m, 6444 m, 
0000 m, 00f0 m, 0ff0 m, 0000 m, 0000 m, 0000 m, 0000 m, 0000 m, 
0000 m, 0000 m, 0000 m, 0000 m, 0000 m, 0000 m, 0000 m, 0000 m, 
0000 m, 006c m, 7c54 m, 6c00 m, 1818 m, 2418 m, 1800 m, 1860 m, 
2418 m, 6066 m, 0c66 m, 6618 m, 660c m, 1818 m, 0c00 m, 3000 m, 
60c6 m, 6630 m, 6c60 m, 6066 m, 6618 m, 666c m, 6066 m, 6e66 m, 
606e m, 6c66 m, 1866 m, 3866 m, 6618 m, 6030 m, 060c m, 0000 m, 
0066 m, 6660 m, 6660 m, 303e m, 6618 m, 186c m, 18c6 m, 6666 m, 
7c3e m, 6006 m, 1866 m, 3cd6 m, 3c3e m, 3018 m, 1818 m, 0055 m, 
8040 m, 2010 m, 0804 m, 0201 m, 0000 m, 0000 m, 00ff m, 0000 m, 
0000 m, 00c0 m, e0f0 m, 0420 m, fc3f m, 07e0 m, 04e0 m, 2007 m, 
0010 m, 3820 m, 447c m, 1004 m, 0054 m, 0014 m, 0000 m, 6c00 m, 
0000 m, 0000 m, 0064 m, 1400 m, 0000 m, 7c50 m, 2808 m, 2c44 m, 
4444 m, 4444 m, 4444 m, 8844 m, 4040 m, 4040 m, 1010 m, 1010 m, 
484c m, 4444 m, 4444 m, 4444 m, 6444 m, 4444 m, 4410 m, 2064 m, 
4444 m, 4444 m, 4464 m, 9044 m, 4040 m, 4040 m, 1010 m, 1010 m, 
4444 m, 4444 m, 4444 m, 4410 m, 7844 m, 4444 m, 443c m, 583c m, 
0000 m, 00f0 m, 0ff0 m, 0000 m, 0000 m, 0000 m, 0000 m, 0000 m, 
0000 m, 0000 m, 0000 m, 0000 m, 0000 m, 0000 m, 0000 m, 0000 m, 
0018 m, 006c m, 181c m, 3a00 m, 0c30 m, 0000 m, 1000 m, 1800 m, 
183c m, 7e3c m, 0c3c m, 3c18 m, 3c38 m, 1810 m, 0400 m, 2018 m, 
3cc6 m, 7c1e m, 787e m, 603c m, 663c m, 3c66 m, 7e66 m, 663c m, 
603c m, 663c m, 183c m, 1042 m, 6618 m, 7e3c m, 003c m, 007e m, 
003a m, 7c3e m, 3e3c m, 3006 m, 663c m, 1866 m, 0cc6 m, 663c m, 
6006 m, 607c m, 0c3a m, 187c m, 6606 m, 7e0c m, 1830 m, 00aa m, 
8040 m, 2010 m, 0804 m, 0201 m, 0000 m, 0000 m, 0000 m, ff00 m, 
0000 m, 00c0 m, e0f0 m, 0240 m, fe7f m, 03c0 m, 0400 m, 2000 m, 
0010 m, 105c m, 0010 m, 1038 m, 0038 m, 0000 m, 0000 m, 3800 m, 
007c m, 0000 m, 005c m, 1400 m, 0800 m, 0000 m, 3810 m, 5c38 m, 
7c7c m, 7c7c m, 7c7c m, 8e38 m, 7c7c m, 7c7c m, 3838 m, 3838 m, 
7044 m, 3838 m, 3838 m, 3800 m, 7838 m, 3838 m, 3810 m, 2058 m, 
3c3c m, 3c3c m, 3c3c m, 6e38 m, 3838 m, 3838 m, 3838 m, 3838 m, 
3844 m, 3838 m, 3838 m, 3800 m, 8038 m, 3838 m, 3804 m, 4004 m, 
0000 m, 00f0 m, 0ff0 m, 0000 m, 0000 m, 0000 m, 0000 m, 0000 m, 
0000 m, 0000 m, 0000 m, 0000 m, 0000 m, 0000 m, 0000 m, 0000 m, 
0000 m, 0000 m, 0000 m, 0000 m, 0000 m, 0000 m, 2000 m, 0000 m, 
0000 m, 0000 m, 0000 m, 0000 m, 0000 m, 0020 m, 0000 m, 0000 m, 
0000 m, 0000 m, 0000 m, 0000 m, 0000 m, 0000 m, 0000 m, 0000 m, 
0006 m, 0000 m, 0000 m, 0000 m, 0000 m, 0000 m, 0000 m, 0000 m, 
0000 m, 0000 m, 0000 m, 003c m, 0000 m, 7000 m, 0000 m, 0000 m, 
6006 m, 0000 m, 0000 m, 0000 m, 003c m, 0000 m, 0000 m, 0055 m, 
8040 m, 2010 m, 0804 m, 0201 m, 0000 m, 0000 m, 0000 m, 00ff m, 
0000 m, 00c0 m, e0f0 m, 0180 m, ffff m, 0180 m, 0400 m, 2000 m, 
0000 m, 0000 m, 0000 m, 0000 m, 0000 m, 0000 m, 0000 m, 0000 m, 
0000 m, 0000 m, 0040 m, 0000 m, 1000 m, 0000 m, 0838 m, 0400 m, 
4444 m, 4444 m, 4444 m, 0060 m, 0000 m, 0000 m, 0000 m, 0000 m, 
0000 m, 0000 m, 0000 m, 0000 m, 0000 m, 0000 m, 0000 m, 0080 m, 
0000 m, 0000 m, 0000 m, 0060 m, 0000 m, 0000 m, 0000 m, 0000 m, 
0000 m, 0000 m, 0000 m, 0000 m, 0000 m, 0000 m, 0038 m, 4038 m, 
decimal
\ =============================================================


create, *640tab \ =============================================
0 ,,		640 ,,		1280 ,,		1920 ,,
2560 ,,		3200 ,,		3840 ,,		4480 ,,
5120 ,,		5760 ,,		6400 ,,		7040 ,,
7680 ,,		8320 ,,		8960 ,,		9600 ,,
10240 ,,	10880 ,,	11520 ,,	12160 ,,
12800 ,,	13440 ,,	14080 ,,	14720 ,,
15360 ,,
\ =============================================================

create, hextab \ ==============================================
$30 c,, $31 c,, $32 c,, $33 c,, $34 c,, $35 c,, $36 c,, $37 c,,
$38 c,, $39 c,, $41 c,, $42 c,, $43 c,, $44 c,, $45 c,, $46 c,,
\ =============================================================

create, /16tab \ ==============================================
$00 c,, $00 c,, $00 c,, $00 c,, $00 c,, $00 c,, $00 c,, $00 c,,
$00 c,, $00 c,, $00 c,, $00 c,, $00 c,, $00 c,, $00 c,, $00 c,,
$01 c,, $01 c,, $01 c,, $01 c,, $01 c,, $01 c,, $01 c,, $01 c,,
$01 c,, $01 c,, $01 c,, $01 c,, $01 c,, $01 c,, $01 c,, $01 c,,
$02 c,, $02 c,, $02 c,, $02 c,, $02 c,, $02 c,, $02 c,, $02 c,,
$02 c,, $02 c,, $02 c,, $02 c,, $02 c,, $02 c,, $02 c,, $02 c,,
$03 c,, $03 c,, $03 c,, $03 c,, $03 c,, $03 c,, $03 c,, $03 c,,
$03 c,, $03 c,, $03 c,, $03 c,, $03 c,, $03 c,, $03 c,, $03 c,,
$04 c,, $04 c,, $04 c,, $04 c,, $04 c,, $04 c,, $04 c,, $04 c,,
$04 c,, $04 c,, $04 c,, $04 c,, $04 c,, $04 c,, $04 c,, $04 c,,
$05 c,, $05 c,, $05 c,, $05 c,, $05 c,, $05 c,, $05 c,, $05 c,,
$05 c,, $05 c,, $05 c,, $05 c,, $05 c,, $05 c,, $05 c,, $05 c,,
$06 c,, $06 c,, $06 c,, $06 c,, $06 c,, $06 c,, $06 c,, $06 c,,
$06 c,, $06 c,, $06 c,, $06 c,, $06 c,, $06 c,, $06 c,, $06 c,,
$07 c,, $07 c,, $07 c,, $07 c,, $07 c,, $07 c,, $07 c,, $07 c,,
$07 c,, $07 c,, $07 c,, $07 c,, $07 c,, $07 c,, $07 c,, $07 c,,
$08 c,, $08 c,, $08 c,, $08 c,, $08 c,, $08 c,, $08 c,, $08 c,,
$08 c,, $08 c,, $08 c,, $08 c,, $08 c,, $08 c,, $08 c,, $08 c,,
$09 c,, $09 c,, $09 c,, $09 c,, $09 c,, $09 c,, $09 c,, $09 c,,
$09 c,, $09 c,, $09 c,, $09 c,, $09 c,, $09 c,, $09 c,, $09 c,,
$0A c,, $0A c,, $0A c,, $0A c,, $0A c,, $0A c,, $0A c,, $0A c,,
$0A c,, $0A c,, $0A c,, $0A c,, $0A c,, $0A c,, $0A c,, $0A c,,
$0B c,, $0B c,, $0B c,, $0B c,, $0B c,, $0B c,, $0B c,, $0B c,,
$0B c,, $0B c,, $0B c,, $0B c,, $0B c,, $0B c,, $0B c,, $0B c,,
$0C c,, $0C c,, $0C c,, $0C c,, $0C c,, $0C c,, $0C c,, $0C c,,
$0C c,, $0C c,, $0C c,, $0C c,, $0C c,, $0C c,, $0C c,, $0C c,,
$0D c,, $0D c,, $0D c,, $0D c,, $0D c,, $0D c,, $0D c,, $0D c,,
$0D c,, $0D c,, $0D c,, $0D c,, $0D c,, $0D c,, $0D c,, $0D c,,
$0E c,, $0E c,, $0E c,, $0E c,, $0E c,, $0E c,, $0E c,, $0E c,,
$0E c,, $0E c,, $0E c,, $0E c,, $0E c,, $0E c,, $0E c,, $0E c,,
$0F c,, $0F c,, $0F c,, $0F c,, $0F c,, $0F c,, $0F c,, $0F c,,
$0F c,, $0F c,, $0F c,, $0F c,, $0F c,, $0F c,, $0F c,, $0F c,,
\ =============================================================

( Screen I/O )

:, z		0 #, p @, !,   p @, 2 #, +, p !, ;,
:, cls0		p @, -eovm +, $8000 #, and, if, z again, then, ;,

:, r		p @, c@, 255 #, xor, p @, c!,   p @, 80 #, +, p !, ;,
:, 640y		y @, y @, +, *640tab +, @, ;,
:, y<H		y @, -H +, $8000 #, and, if, ;, then, H-1 y !, ;,
:, 0<=y		y @, $8000 #, and, if, 0 #, y !, then, ;,
:, yrng		0<=y y<H ;,
:, x<W		x @, -W +, $8000 #, and, if, ;, then, W-1 x !, ;,
:, 0<=x		x @, $8000 #, and, if, 0 #, x !, then, ;,
:, xrng		0<=x x<W ;,
:, p0		xrng yrng x @, 1 #, xor, 640y +, Base +, p !, ;,
:, q0		fontBase g c@, +, q !, ;,
:, gl		q @, c@, p @, c!,  q @, 256 #, +, q !,  p @, W +, p !, ;,
:, cpy		q @, @, p @, !,  q @, 2 #, +, q !,  p @, 2 #, +, p !, ;,
:, cp		q @, -eovm +, $8000 #, and, if, cpy again, then, ;,
:, up		Base p !, Base 640 #, +, q !, cp ;,

:, cls		Base p !, cls0 ;,
:, cursor	p0 r r r r r r r r ;,
:, home		0 #, x !,  0 #, y !, ;,
:, plot		p0 q0 gl gl gl gl gl gl gl gl ;,
:, scroll	up cls0 ;,


( Print a character )

:, (cr)		y @, H-1 xor, if, y @, 1 #, +, y !, ;, then, scroll ;,
:, cr		(cr) 0 #, x !, ;,
:, emit		plot x @, W-1 xor, if, x @, 1 #, +, x !, ;, then, cr ;,

( Print PS/2 Data to the screen )

:, digit	g c@, hextab +, c@, g c!, emit ;,
:, sp		32 #, g c!, emit ;,
:, lsn		k c@, 15 #, and, g c!, digit ;,
:, msn		k c@, /16tab +, c@, g c!, digit ;,
:, print	kqdata c@, k c!, msn lsn sp kqdata c!, ;,
:, avail	kqstat c@, 1 #, and, 1 #, xor, ;,

( Blink Period Expired )

:, dec		counter @, -1 #, +, counter !, ;,
:, reset	TBlink counter !, ;,
:, elapsed	dec counter @, if, 0 #, ;, then, 1 #, ;,

( Toggle Cursor Visibility )

:, on		1 #, vis !, ;,
:, off		0 #, vis !, ;,
:, on?		vis @, ;,
:, toggle	on? if, off ;, then, on ;,
:, blink	toggle cursor ;,

( System Bootstrap )

:, ?data	avail if, print then, ;,
:, ?blink	elapsed if, blink then, ;,
:, main		?blink ?data again, ;,
:, boot		home off reset cls main ;,

' boot >body @ is, bootstrap

