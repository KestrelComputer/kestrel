\ Dependencies:
\
\ waitps2 ( -- )	Waits for at least one PS/2 data byte to arrive.  This will block indefinitely.
\ ackps2 ( -- )		Acknowledges the PS/2 controller by dequeueing the head byte.
\ headps2 ( -- )	Sets variable ps2code to the current head of the PS/2 input queue.  This does not pop the queue.
\
\ shiftst ( -- a )	Variable containing the current shift state.
\ ps2code ( -- a )  Variable holding the most recently read PS/2 byte.  Set by headps2, read-only everywhere else.
\ ckey ( -- a )		Variable containing the "cooked" key code (expressed as ASCII if at all possible).


create, unshifted-table hex
	0000 ,, 0118 ,, 0000 ,, 0114 ,, 0112 ,, 0110 ,, 0111 ,, 011B ,, 0000 ,, 0119 ,, 0117 ,, 0115 ,, 0113 ,, 0009 ,, 0060 ,, 0000 ,,
	0000 ,, 0000 ,, 0000 ,, 0000 ,, 0000 ,, 0071 ,, 0031 ,, 0000 ,, 0000 ,, 0000 ,, 007A ,, 0073 ,, 0061 ,, 0077 ,, 0032 ,, 0000 ,,
	0000 ,, 0063 ,, 0078 ,, 0064 ,, 0065 ,, 0034 ,, 0033 ,, 0000 ,, 0000 ,, 0020 ,, 0076 ,, 0066 ,, 0074 ,, 0072 ,, 0035 ,, 0000 ,,
	0000 ,, 006E ,, 0062 ,, 0068 ,, 0067 ,, 0079 ,, 0036 ,, 0000 ,, 0000 ,, 0000 ,, 006D ,, 006A ,, 0075 ,, 0037 ,, 0038 ,, 0000 ,,
	0000 ,, 002C ,, 006B ,, 0069 ,, 006F ,, 0030 ,, 0039 ,, 0000 ,, 0000 ,, 002E ,, 002F ,, 006C ,, 003B ,, 0070 ,, 002D ,, 0000 ,,
	0000 ,, 0000 ,, 0027 ,, 0000 ,, 005B ,, 003D ,, 0000 ,, 0000 ,, 0000 ,, 0000 ,, 000D ,, 005D ,, 0000 ,, 005C ,, 0000 ,, 0000 ,,
	0000 ,, 0000 ,, 0000 ,, 0000 ,, 0000 ,, 0000 ,, 0008 ,, 0000 ,, 0000 ,, 0000 ,, 0000 ,, 0100 ,, 0000 ,, 0000 ,, 0000 ,, 0000 ,,
	0000 ,, 0000 ,, 0102 ,, 0000 ,, 0101 ,, 0103 ,, 001B ,, 0000 ,, 011A ,, 0000 ,, 0000 ,, 0000 ,, 0000 ,, 0000 ,, 0000 ,, 0000 ,,
	0000 ,, 0000 ,, 0000 ,, 0116 ,, 0000 ,, 0000 ,, 0000 ,, 0000 ,, 0000 ,, 0000 ,, 0000 ,, 0000 ,, 0061 ,, 0000 ,, 0000 ,, 0000 ,,
	0000 ,, 0000 ,, 0000 ,, 0000 ,, 0000 ,, 0000 ,, 0000 ,, 0000 ,, 0000 ,, 0000 ,, 0000 ,, 0000 ,, 0000 ,, 0000 ,, 0000 ,, 0000 ,,
	0000 ,, 0000 ,, 0000 ,, 0000 ,, 0000 ,, 0000 ,, 0000 ,, 0000 ,, 0000 ,, 0000 ,, 0000 ,, 0000 ,, 0000 ,, 0000 ,, 0000 ,, 0000 ,,
	0000 ,, 0000 ,, 0000 ,, 0000 ,, 0000 ,, 0000 ,, 0000 ,, 0000 ,, 0000 ,, 0000 ,, 0000 ,, 0000 ,, 0000 ,, 0000 ,, 0000 ,, 0000 ,,

create, shifted-table hex
	0000 ,, 0118 ,, 0000 ,, 0114 ,, 0112 ,, 0110 ,, 0111 ,, 011B ,, 0000 ,, 0119 ,, 0117 ,, 0115 ,, 0113 ,, 0009 ,, 007E ,, 0000 ,,
	0000 ,, 0000 ,, 0000 ,, 0000 ,, 0000 ,, 0051 ,, 0021 ,, 0000 ,, 0000 ,, 0000 ,, 005A ,, 0053 ,, 0041 ,, 0057 ,, 0040 ,, 0000 ,,
	0000 ,, 0043 ,, 0058 ,, 0044 ,, 0045 ,, 0024 ,, 0023 ,, 0000 ,, 0000 ,, 0020 ,, 0056 ,, 0046 ,, 0054 ,, 0052 ,, 0025 ,, 0000 ,,
	0000 ,, 004E ,, 0042 ,, 0048 ,, 0047 ,, 0059 ,, 005E ,, 0000 ,, 0000 ,, 0000 ,, 004D ,, 004A ,, 0055 ,, 0026 ,, 002A ,, 0000 ,,
	0000 ,, 003C ,, 004B ,, 0049 ,, 004F ,, 0029 ,, 0028 ,, 0000 ,, 0000 ,, 003E ,, 003F ,, 004C ,, 003A ,, 0050 ,, 005F ,, 0000 ,,
	0000 ,, 0000 ,, 0022 ,, 0000 ,, 007B ,, 002B ,, 0000 ,, 0000 ,, 0000 ,, 0000 ,, 000D ,, 007D ,, 0000 ,, 007C ,, 0000 ,, 0000 ,,
	0000 ,, 0000 ,, 0000 ,, 0000 ,, 0000 ,, 0000 ,, 0008 ,, 0000 ,, 0000 ,, 0000 ,, 0000 ,, 0100 ,, 0000 ,, 0000 ,, 0000 ,, 0000 ,,
	0000 ,, 0000 ,, 0102 ,, 0000 ,, 0101 ,, 0103 ,, 001B ,, 0000 ,, 011A ,, 0000 ,, 0000 ,, 0000 ,, 0000 ,, 0000 ,, 0000 ,, 0000 ,,
	0000 ,, 0000 ,, 0000 ,, 0116 ,, 0000 ,, 0000 ,, 0000 ,, 0000 ,, 0000 ,, 0000 ,, 0000 ,, 0000 ,, 0041 ,, 0000 ,, 0000 ,, 0000 ,,
	0000 ,, 0000 ,, 0000 ,, 0000 ,, 0000 ,, 0000 ,, 0000 ,, 0000 ,, 0000 ,, 0000 ,, 0000 ,, 0000 ,, 0000 ,, 0000 ,, 0000 ,, 0000 ,,
	0000 ,, 0000 ,, 0000 ,, 0000 ,, 0000 ,, 0000 ,, 0000 ,, 0000 ,, 0000 ,, 0000 ,, 0000 ,, 0000 ,, 0000 ,, 0000 ,, 0000 ,, 0000 ,,
	0000 ,, 0000 ,, 0000 ,, 0000 ,, 0000 ,, 0000 ,, 0000 ,, 0000 ,, 0000 ,, 0000 ,, 0000 ,, 0000 ,, 0000 ,, 0000 ,, 0000 ,, 0000 ,,
	
create, ctrled-table hex
	0000 ,, 0118 ,, 0000 ,, 0114 ,, 0112 ,, 0110 ,, 0111 ,, 011B ,, 0000 ,, 0119 ,, 0117 ,, 0115 ,, 0113 ,, 0009 ,, 007E ,, 0000 ,,
	0000 ,, 0000 ,, 0000 ,, 0000 ,, 0000 ,, 0011 ,, 0021 ,, 0000 ,, 0000 ,, 0000 ,, 001A ,, 0013 ,, 0001 ,, 0017 ,, 0000 ,, 0000 ,,
	0000 ,, 0003 ,, 0018 ,, 0004 ,, 0005 ,, 0024 ,, 0023 ,, 0000 ,, 0000 ,, 0020 ,, 0016 ,, 0006 ,, 0014 ,, 0012 ,, 0025 ,, 0000 ,,
	0000 ,, 000E ,, 0002 ,, 0008 ,, 0007 ,, 0019 ,, 005E ,, 0000 ,, 0000 ,, 0000 ,, 000D ,, 000A ,, 0015 ,, 0026 ,, 002A ,, 0000 ,,
	0000 ,, 003C ,, 000B ,, 0009 ,, 000F ,, 0029 ,, 0028 ,, 0000 ,, 0000 ,, 003E ,, 003F ,, 000C ,, 003A ,, 0010 ,, 005F ,, 0000 ,,
	0000 ,, 0000 ,, 0022 ,, 0000 ,, 007B ,, 002B ,, 0000 ,, 0000 ,, 0000 ,, 0000 ,, 000D ,, 007D ,, 0000 ,, 007C ,, 0000 ,, 0000 ,,
	0000 ,, 0000 ,, 0000 ,, 0000 ,, 0000 ,, 0000 ,, 0008 ,, 0000 ,, 0000 ,, 0000 ,, 0000 ,, 0100 ,, 0000 ,, 0000 ,, 0000 ,, 0000 ,,
	0000 ,, 0000 ,, 0102 ,, 0000 ,, 0101 ,, 0103 ,, 001B ,, 0000 ,, 011A ,, 0000 ,, 0000 ,, 0000 ,, 0000 ,, 0000 ,, 0000 ,, 0000 ,,
	0000 ,, 0000 ,, 0000 ,, 0116 ,, 0000 ,, 0000 ,, 0000 ,, 0000 ,, 0000 ,, 0000 ,, 0000 ,, 0000 ,, 0001 ,, 0000 ,, 0000 ,, 0000 ,,
	0000 ,, 0000 ,, 0000 ,, 0000 ,, 0000 ,, 0000 ,, 0000 ,, 0000 ,, 0000 ,, 0000 ,, 0000 ,, 0000 ,, 0000 ,, 0000 ,, 0000 ,, 0000 ,,
	0000 ,, 0000 ,, 0000 ,, 0000 ,, 0000 ,, 0000 ,, 0000 ,, 0000 ,, 0000 ,, 0000 ,, 0000 ,, 0000 ,, 0000 ,, 0000 ,, 0000 ,, 0000 ,,
	0000 ,, 0000 ,, 0000 ,, 0000 ,, 0000 ,, 0000 ,, 0000 ,, 0000 ,, 0000 ,, 0000 ,, 0000 ,, 0000 ,, 0000 ,, 0000 ,, 0000 ,, 0000 ,,

decimal

int, received
int, up/dn

:, 0keyboard	0 #, shiftst !, ;,

:, unshifted	ps2code c@, ps2code c@, +, unshifted-table +, @, ckey !, ;,
:, shifted		ps2code c@, ps2code c@, +, shifted-table +, @, ckey !, ;,
:, ctrled		ps2code c@, ps2code c@, +, ctrled-table +, @, ckey !, ;,
:, (ctrled)		shiftst @, 1 #, and, if, ctrled then, ;,
:, (shifted)	shiftst @, 2 #, and, if, shifted then, ;,
:, (unshifted)	shiftst @, if, exit, then, unshifted ;,
:, lookup		up/dn @, if, 0 #, ckey !, exit, then, (ctrled) (shifted) (unshifted) ;,
:, F0?			ps2code c@, $F0 #, xor, if, exit, then,  1 #, up/dn !, ;,
:, <C0?			ps2code c@, -$C0 #, +, $8000 #, and, if, 1 #, received !, then, ;,

:, ctrl0		shiftst @, $FFFE #, and, shiftst !, ;,
:, dn			up/dn @, if, exit, then,  ctrl0  shiftst @, 1 #, xor, shiftst !, ;,
:, up			up/dn @, if, ctrl0 then, ;,
:, ctrl			ps2code c@, $14 #, xor, if, exit, then,  up dn ;,

:, shift0		shiftst @, $FFFD #, and, shiftst !, ;,
:, dn			up/dn @, if, exit, then,  shift0 shiftst @, 2 #, xor, shiftst !, ;,
:, up			up/dn @, if, shift0 then, ;,
:, lshift		ps2code c@, $12 #, xor, if, exit, then,  up dn ;,
:, rshift		ps2code c@, $59 #, xor, if, exit, then,  up dn ;,

:, shifts		lshift rshift ctrl ;,
:, byte			waitps2 headps2 ackps2 ;,
:, (t)			byte F0? shifts <C0?  received @,  if, lookup exit, then, again, ;,
:, translate	0 #, received !,  0 #, up/dn !,  (t) ;,
:, getkey		0 #, ckey c!,  translate  ckey @, if, exit, then, again, ;,

\ Extended cooked keycodes:

hex

0100 const, CK_LEFT
0101 const, CK_RIGHT
0102 const, CK_DOWN
0103 const, CK_UP

0110 const, CK_F1
0111 const, CK_F2
0112 const, CK_F3
0113 const, CK_F4

0114 const, CK_F5
0115 const, CK_F6
0116 const, CK_F7
0117 const, CK_F8

0118 const, CK_F9
0119 const, CK_F10
011A const, CK_F11
011B const, CK_F12

0008 const, CK_BKSP
0009 const, CK_TAB
000D const, CK_ENTER

decimal
